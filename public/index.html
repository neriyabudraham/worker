<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>××¢×¨×›×ª × ×™×”×•×œ ×‘×•×˜×™×</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/he.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    :root {
      --primary: #4361ee;
      --primary-hover: #3a56d4;
      --bg: #f3f6f9;
      --card-bg: #ffffff;
      --text-main: #2b2d42;
      --text-muted: #8d99ae;
      --border: #e9ecef;
      --success: #10b981;
      --danger: #ef4444;
      --radius: 12px;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Heebo', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header Card */
    .header-card {
      background: var(--card-bg);
      padding: 25px 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-card h1 {
      margin: 0;
      font-size: 1.7rem;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-card h1 i { color: var(--primary); }

    .header-actions { display: flex; gap: 10px; }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
    }

    .stat-card .icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 20px;
    }

    .stat-card:nth-child(1) .icon { background: #e0e7ff; color: #4361ee; }
    .stat-card:nth-child(2) .icon { background: #d1fae5; color: #059669; }
    .stat-card:nth-child(3) .icon { background: #fef3c7; color: #d97706; }
    .stat-card:nth-child(4) .icon { background: #fee2e2; color: #dc2626; }

    .stat-card .number {
      font-size: 2.2rem;
      font-weight: 700;
      color: #1e293b;
      line-height: 1;
    }

    .stat-card .label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* Section Card */
    .section-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .section-header {
      padding: 18px 25px;
      background: linear-gradient(to left, #f8fafc, #fff);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-header .badge {
      background: var(--primary);
      color: #fff;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .section-header.active .badge { background: var(--success); }
    .section-header.inactive .badge { background: #9ca3af; }

    /* Table */
    .table-responsive { overflow-x: auto; }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 900px;
    }

    th {
      text-align: right;
      padding: 14px 18px;
      background: #f8fafc;
      color: #64748b;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    td {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      background: white;
      font-size: 0.95rem;
    }

    tr:hover td { background-color: #f8fafc; }
    tr:last-child td { border-bottom: none; }
    tr.sortable-ghost { background: #e0f2fe; opacity: 0.8; }

    /* Phone Link */
    .phone-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: var(--text-main);
      font-family: 'Courier New', monospace;
      font-weight: 700;
      font-size: 1rem;
      padding: 6px 12px;
      border-radius: 8px;
      transition: all 0.2s;
      background: #f1f5f9;
    }

    .phone-link i { color: #25D366; font-size: 1.15rem; }
    .phone-link:hover { background: #dcfce7; color: #14532d; transform: translateX(-3px); }

    /* Time Tags */
    .time-tag {
      padding: 5px 10px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .time-tag.future { background: #e0f2fe; color: #0369a1; }
    .time-tag.ending-soon { background: #fef9c3; color: #854d0e; }
    .time-tag.ended { background: #f3f4f6; color: #6b7280; text-decoration: line-through; opacity: 0.7; }
    .time-tag.active { background: #dcfce7; color: #15803d; }

    /* Buttons */
    .btn {
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: #f1f5f9; color: #475569; }
    .btn-secondary:hover { background: #e2e8f0; }

    .btn-icon {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: var(--text-muted);
      padding: 8px;
      border-radius: 8px;
      transition: 0.2s;
    }

    .btn-icon:hover { background: #f1f5f9; color: var(--primary); }
    .btn-icon.delete:hover { color: var(--danger); background: #fee2e2; }
    .btn-icon.active { color: var(--success); }

    .drag-handle { cursor: grab; color: #cbd5e1; font-size: 1.1rem; }
    .drag-handle:active { cursor: grabbing; color: var(--primary); }

    /* Form Elements */
    select, input {
      padding: 9px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    /* Add Bot Section */
    .add-bot-section {
      background: #f0f9ff;
      padding: 20px 25px;
      border-radius: 12px;
      border: 1px dashed #bae6fd;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .add-bot-section span {
      font-weight: 600;
      color: #0369a1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-overlay.open { display: flex; }

    .modal-box {
      background: white;
      width: 100%;
      max-width: 550px;
      padding: 0;
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
      animation: slideUp 0.3s ease;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      color: #1e293b;
    }

    .modal-body {
      padding: 25px;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 15px 25px;
      border-top: 1px solid var(--border);
      background: #f8fafc;
    }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea { width: 100%; }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    /* Date Input Group */
    .date-input-group {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      overflow: hidden;
    }

    .date-input-group input {
      border: none;
      flex: 1;
      outline: none;
    }

    .clear-date-btn {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0 12px;
      font-size: 1rem;
    }

    .clear-date-btn:hover { color: var(--danger); }

    /* SQL Editor */
    .sql-editor-container {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #374151;
    }

    .sql-editor {
      width: 100%;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      padding: 15px;
      border: none;
      outline: none;
      resize: vertical;
      line-height: 1.6;
      direction: ltr;
      min-height: 120px;
    }

    .sql-badge {
      position: absolute;
      top: 0;
      right: 0;
      background: #374151;
      color: #fff;
      font-size: 0.7rem;
      padding: 3px 10px;
      border-bottom-left-radius: 6px;
    }

    /* List Items */
    .list-container {
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      background: white;
    }

    .list-item:last-child { border-bottom: none; }
    .list-item:hover { background: #f8fafc; }

    .list-item .phone {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: var(--text-main);
    }

    .list-empty {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }

    /* Loader */
    .loader-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 45px;
      height: 45px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #1e293b;
      color: white;
      padding: 14px 30px;
      border-radius: 30px;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
      z-index: 3000;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      font-weight: 500;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: #9ca3af;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .hidden { display: none !important; }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .stats-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .header-card { flex-direction: column; gap: 15px; text-align: center; }
      .header-actions { width: 100%; justify-content: center; }
      .form-row { grid-template-columns: 1fr; }
      .add-bot-section { justify-content: center; }
      .add-bot-section input { width: 100%; }
    }
  </style>
</head>
<body>

<div class="loader-overlay" id="loader">
  <div class="spinner"></div>
</div>

<div class="container">
  <!-- Header -->
  <div class="header-card">
    <h1><i class="fa-solid fa-robot"></i> ××¢×¨×›×ª × ×™×”×•×œ ×‘×•×˜×™×</h1>
    <div class="header-actions">
      <button class="btn btn-danger" onclick="openBlacklist()">
        <i class="fa-solid fa-ban"></i> × ×™×”×•×œ ×—×¡×•××™×
      </button>
      <button class="btn btn-secondary" onclick="loadData()">
        <i class="fa-solid fa-refresh"></i>
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="icon"><i class="fa-solid fa-robot"></i></div>
      <div class="number" id="stat-total">0</div>
      <div class="label">×¡×”×´×› ×‘×•×˜×™×</div>
    </div>
    <div class="stat-card">
      <div class="icon"><i class="fa-solid fa-circle-check"></i></div>
      <div class="number" id="stat-active">0</div>
      <div class="label">×¤×¢×™×œ×™×</div>
    </div>
    <div class="stat-card">
      <div class="icon"><i class="fa-solid fa-message"></i></div>
      <div class="number" id="stat-messages">0</div>
      <div class="label">×”×•×“×¢×•×ª ×”×™×•×</div>
    </div>
    <div class="stat-card">
      <div class="icon"><i class="fa-solid fa-ban"></i></div>
      <div class="number" id="stat-blocked">0</div>
      <div class="label">×—×¡×•××™×</div>
    </div>
  </div>

  <!-- Active Bots Section -->
  <div class="section-card">
    <div class="section-header active">
      <h2><i class="fa-solid fa-circle-check"></i> ×‘×•×˜×™× ×¤×¢×™×œ×™× <span class="badge" id="active-count">0</span></h2>
    </div>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th style="width:40px"></th>
            <th style="width:60px">ID</th>
            <th>××¡×¤×¨</th>
            <th>Workflow</th>
            <th style="width:120px">×¡×˜×˜×•×¡</th>
            <th>×ª×–××•×Ÿ</th>
            <th>×’×™×©×”</th>
            <th style="width:120px">×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody id="activeTableBody"></tbody>
      </table>
    </div>
    <div id="activeEmpty" class="empty-state hidden">
      <i class="fa-solid fa-circle-pause"></i>
      <p>××™×Ÿ ×‘×•×˜×™× ×¤×¢×™×œ×™×</p>
    </div>
  </div>

  <!-- Inactive Bots Section -->
  <div class="section-card">
    <div class="section-header inactive">
      <h2><i class="fa-solid fa-circle-pause"></i> ×‘×•×˜×™× ×›×‘×•×™×™× <span class="badge" id="inactive-count">0</span></h2>
    </div>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th style="width:40px"></th>
            <th style="width:60px">ID</th>
            <th>××¡×¤×¨</th>
            <th>Workflow</th>
            <th style="width:120px">×¡×˜×˜×•×¡</th>
            <th>×ª×–××•×Ÿ</th>
            <th>×’×™×©×”</th>
            <th style="width:120px">×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody id="inactiveTableBody"></tbody>
      </table>
    </div>
    <div id="inactiveEmpty" class="empty-state hidden">
      <i class="fa-solid fa-check-circle"></i>
      <p>×›×œ ×”×‘×•×˜×™× ×¤×¢×™×œ×™×!</p>
    </div>
  </div>

  <!-- Add Bot -->
  <div class="add-bot-section">
    <span><i class="fa-solid fa-plus-circle"></i> ×”×•×¡×¤×ª ×‘×•×˜ ×—×“×©:</span>
    <input type="tel" id="newBotPhone" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ (972...)" style="width: 250px;">
    <button class="btn btn-primary" onclick="addBot()">
      <i class="fa-solid fa-plus"></i> ×”×•×¡×£
    </button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-gear"></i> ×”×’×“×¨×•×ª ×‘×•×˜</h3>
      <button class="btn-icon" onclick="closeModal('settingsModal')">
        <i class="fa-solid fa-xmark fa-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editBotId">

      <div class="form-group">
        <label><i class="fa-solid fa-diagram-project"></i> Workflow</label>
        <select id="editWorkflow"></select>
      </div>

      <div class="form-group">
        <label><i class="fa-solid fa-lock-open"></i> ××¦×‘ ×’×™×©×”</label>
        <select id="editAccess" onchange="toggleDynamic()">
          <option value="everyone">ğŸ”“ ×›×•×œ×</option>
          <option value="whitelist">ğŸ“ ×¨×©×™××” ×œ×‘× ×”</option>
          <option value="dynamic">âš¡ ×©××™×œ×ª×” ×“×™× ×××™×ª</option>
        </select>
      </div>

      <div class="form-group">
        <label><i class="fa-regular fa-calendar-days"></i> ×ª×–××•×Ÿ ×¤×¢×™×œ×•×ª</label>
        <div class="form-row">
          <div>
            <small style="color: var(--text-muted);">×¤×¢×™×œ ×-:</small>
            <div class="date-input-group">
              <input type="text" id="editFrom" placeholder="×‘×—×¨ ×ª××¨×™×š...">
              <button class="clear-date-btn" onclick="fpFrom.clear()"><i class="fa-solid fa-circle-xmark"></i></button>
            </div>
          </div>
          <div>
            <small style="color: var(--text-muted);">×¤×¢×™×œ ×¢×“-:</small>
            <div class="date-input-group">
              <input type="text" id="editUntil" placeholder="×‘×—×¨ ×ª××¨×™×š...">
              <button class="clear-date-btn" onclick="fpUntil.clear()"><i class="fa-solid fa-circle-xmark"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label><i class="fa-solid fa-stopwatch"></i> ×”×©×”×™×” (×©× ×™×•×ª)</label>
        <input type="number" id="editDelay" value="0" min="0" style="width: 120px;">
      </div>

      <div class="form-group hidden" id="dynamicGroup">
        <label><i class="fa-solid fa-database"></i> ×©××™×œ×ª×” ×“×™× ×××™×ª (SQL)</label>
        <div class="sql-editor-container">
          <span class="sql-badge">SQL</span>
          <textarea id="editQuery" class="sql-editor" placeholder="SELECT * FROM users WHERE phone = '{{phone}}'"></textarea>
        </div>
        <small style="color: var(--text-muted); margin-top: 8px; display: block;">
          ğŸ’¡ ×”×©×ª××© ×‘-<code style="background:#f1f5f9; padding: 2px 6px; border-radius: 4px;">{{phone}}</code> ×œ××¡×¤×¨ ×”×œ×§×•×—
        </small>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" style="width: 100%;" onclick="saveSettings()">
        <i class="fa-solid fa-check"></i> ×©××•×¨ ×”×’×“×¨×•×ª
      </button>
    </div>
  </div>
</div>

<!-- List Modal -->
<div class="modal-overlay" id="listModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="listModalTitle"><i class="fa-solid fa-list"></i> × ×™×”×•×œ ×¨×©×™××”</h3>
      <button class="btn-icon" onclick="closeModal('listModal')">
        <i class="fa-solid fa-xmark fa-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <input type="tel" id="listPhoneInput" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ..." style="flex: 1;">
        <button class="btn btn-primary" onclick="addToList()">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>
      <div class="list-container" id="listContainer"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const API = '';
  let bots = [];
  let workflows = [];
  let blacklist = [];
  let whitelist = [];
  let currentListType = '';
  let currentBotId = null;
  let fpFrom, fpUntil;

  document.addEventListener('DOMContentLoaded', () => {
    const config = {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      time_24hr: true,
      locale: "he",
      disableMobile: true
    };
    fpFrom = flatpickr("#editFrom", config);
    fpUntil = flatpickr("#editUntil", config);
    loadData();
  });

  async function loadData() {
    showLoader(true);
    try {
      const [botsRes, workflowsRes, blockedRes, statsRes] = await Promise.all([
        fetch(`${API}/api/bots`),
        fetch(`${API}/api/n8n/workflows`),
        fetch(`${API}/api/blocked`),
        fetch(`${API}/api/admin/stats`)
      ]);

      bots = await botsRes.json();
      workflows = await workflowsRes.json();
      blacklist = await blockedRes.json();
      const stats = await statsRes.json();

      document.getElementById('stat-total').textContent = bots.length;
      document.getElementById('stat-active').textContent = bots.filter(b => b.status === 'active').length;
      document.getElementById('stat-messages').textContent = stats.today_messages || 0;
      document.getElementById('stat-blocked').textContent = blacklist.length;

      renderTables();
    } catch (e) {
      console.error(e);
      showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×');
    }
    showLoader(false);
  }

  function renderTables() {
    const activeBots = bots.filter(b => b.status === 'active').sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
    const inactiveBots = bots.filter(b => b.status !== 'active').sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));

    document.getElementById('active-count').textContent = activeBots.length;
    document.getElementById('inactive-count').textContent = inactiveBots.length;

    const activeBody = document.getElementById('activeTableBody');
    const inactiveBody = document.getElementById('inactiveTableBody');

    activeBody.innerHTML = activeBots.map(bot => renderBotRow(bot)).join('');
    inactiveBody.innerHTML = inactiveBots.map(bot => renderBotRow(bot)).join('');

    document.getElementById('activeEmpty').classList.toggle('hidden', activeBots.length > 0);
    document.getElementById('inactiveEmpty').classList.toggle('hidden', inactiveBots.length > 0);
    
    activeBody.closest('.table-responsive').classList.toggle('hidden', activeBots.length === 0);
    inactiveBody.closest('.table-responsive').classList.toggle('hidden', inactiveBots.length === 0);

    // Init sortable
    [activeBody, inactiveBody].forEach(tbody => {
      if (tbody.sortable) tbody.sortable.destroy();
      tbody.sortable = Sortable.create(tbody, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: saveOrder
      });
    });
  }

  function renderBotRow(bot) {
    const isActive = bot.status === 'active';
    const waLink = `https://wa.me/${bot.phone_number}`;
    const workflowName = bot.workflow_name || workflows.find(w => w.id === bot.workflow_id)?.name || '';

    let workflowOpts = '<option value="">-- ×œ×œ× --</option>';
    workflows.forEach(w => {
      workflowOpts += `<option value="${w.id}" ${w.id === bot.workflow_id ? 'selected' : ''}>${w.name}</option>`;
    });

    const accessOpts = `
      <option value="everyone" ${bot.access_mode === 'everyone' ? 'selected' : ''}>ğŸ”“ ×›×•×œ×</option>
      <option value="whitelist" ${bot.access_mode === 'whitelist' ? 'selected' : ''}>ğŸ“ ×¨×©×™××” ×œ×‘× ×”</option>
      <option value="dynamic" ${bot.access_mode === 'dynamic' ? 'selected' : ''}>âš¡ ×“×™× ×××™</option>
    `;

    return `
      <tr data-id="${bot.id}">
        <td><i class="fa-solid fa-grip-vertical drag-handle"></i></td>
        <td style="color: #94a3b8; font-size: 0.85rem;">${bot.id}</td>
        <td>
          <a href="${waLink}" target="_blank" class="phone-link">
            <i class="fa-brands fa-whatsapp"></i> ${bot.phone_number}
          </a>
        </td>
        <td>
          <select onchange="updateBot(${bot.id}, 'workflow_id', this.value, this)" style="min-width: 180px;">
            ${workflowOpts}
          </select>
        </td>
        <td>
          <select onchange="updateBot(${bot.id}, 'status', this.value, this)"
                  style="font-weight: 600; color: ${isActive ? 'var(--success)' : 'var(--danger)'}; border-color: ${isActive ? 'var(--success)' : '#d1d5db'};">
            <option value="active" ${isActive ? 'selected' : ''}>×¤×¢×™×œ</option>
            <option value="inactive" ${!isActive ? 'selected' : ''}>×›×‘×•×™</option>
          </select>
        </td>
        <td>${getTimeDisplay(bot.active_from, bot.active_until)}</td>
        <td>
          <select onchange="updateBot(${bot.id}, 'access_mode', this.value, this)" style="min-width: 130px;">
            ${accessOpts}
          </select>
        </td>
        <td>
          <div style="display: flex; gap: 5px;">
            <button class="btn-icon ${bot.access_mode === 'whitelist' ? '' : 'hidden'}" onclick="openWhitelist(${bot.id}, '${bot.phone_number}')" title="×¨×©×™××” ×œ×‘× ×”">
              <i class="fa-solid fa-users"></i>
            </button>
            <button class="btn-icon" onclick="openSettings(${bot.id})" title="×”×’×“×¨×•×ª">
              <i class="fa-solid fa-gear"></i>
            </button>
            <button class="btn-icon delete" onclick="deleteBot(${bot.id})" title="××—×§">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }

  function getTimeDisplay(from, until) {
    const now = new Date();
    
    if (!from && !until) {
      return '<span style="color: #cbd5e1; font-size: 1.3rem;" title="×œ×œ× ×”×’×‘×œ×”">âˆ</span>';
    }

    if (from) {
      const fromDate = new Date(from);
      if (now < fromDate) {
        const txt = isToday(fromDate) ? `××ª×—×™×œ ×”×™×•× ${formatTime(fromDate)}` : `××ª×—×™×œ ${formatDate(fromDate)}`;
        return `<span class="time-tag future"><i class="fa-regular fa-clock"></i> ${txt}</span>`;
      }
    }

    if (until) {
      const untilDate = new Date(until);
      if (now > untilDate) {
        return `<span class="time-tag ended">×”×¡×ª×™×™× ${formatDate(untilDate)}</span>`;
      }
      if (isToday(untilDate)) {
        return `<span class="time-tag ending-soon"><i class="fa-solid fa-hourglass-half"></i> ××¡×ª×™×™× ×”×™×•× ${formatTime(untilDate)}</span>`;
      }
      return `<span class="time-tag active"><i class="fa-regular fa-calendar-check"></i> ×¢×“ ${formatDate(untilDate)}</span>`;
    }

    return '<span class="time-tag active">×¤×¢×™×œ</span>';
  }

  function isToday(date) {
    const now = new Date();
    return date.getDate() === now.getDate() && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
  }

  function formatTime(date) {
    return date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
  }

  function formatDate(date) {
    return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
  }

  async function updateBot(id, field, value, el) {
    const bot = bots.find(b => b.id === id);
    const data = { [field]: value || null };

    if (field === 'workflow_id') {
      const wf = workflows.find(w => w.id === value);
      data.workflow_name = wf?.name || null;
    }

    await fetch(`${API}/api/bots/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    Object.assign(bot, data);
    
    if (field === 'status') {
      renderTables();
      updateStats();
    }
    
    showToast('× ×©××¨');
  }

  async function saveOrder() {
    const orders = [];
    document.querySelectorAll('#activeTableBody tr, #inactiveTableBody tr').forEach((tr, idx) => {
      orders.push({ id: parseInt(tr.dataset.id), sort_order: idx });
    });

    await fetch(`${API}/api/bots/reorder`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orders })
    });

    showToast('×”×¡×“×¨ ×¢×•×“×›×Ÿ');
  }

  function openSettings(id) {
    const bot = bots.find(b => b.id === id);
    document.getElementById('editBotId').value = id;

    const sel = document.getElementById('editWorkflow');
    sel.innerHTML = '<option value="">-- ×œ×œ× --</option>' +
      workflows.map(w => `<option value="${w.id}" ${w.id === bot.workflow_id ? 'selected' : ''}>${w.name}</option>`).join('');

    document.getElementById('editAccess').value = bot.access_mode || 'everyone';
    document.getElementById('editDelay').value = bot.delay_seconds || 0;
    document.getElementById('editQuery').value = bot.dynamic_sql_template || '';

    fpFrom.setDate(bot.active_from || null);
    fpUntil.setDate(bot.active_until || null);

    toggleDynamic();
    document.getElementById('settingsModal').classList.add('open');
  }

  function toggleDynamic() {
    document.getElementById('dynamicGroup').classList.toggle('hidden', 
      document.getElementById('editAccess').value !== 'dynamic');
  }

  async function saveSettings() {
    const id = document.getElementById('editBotId').value;
    const workflowId = document.getElementById('editWorkflow').value;
    const workflow = workflows.find(w => w.id === workflowId);

    const data = {
      workflow_id: workflowId || null,
      workflow_name: workflow?.name || null,
      access_mode: document.getElementById('editAccess').value,
      delay_seconds: parseInt(document.getElementById('editDelay').value) || 0,
      dynamic_sql_template: document.getElementById('editQuery').value || null,
      active_from: document.getElementById('editFrom').value || null,
      active_until: document.getElementById('editUntil').value || null
    };

    await fetch(`${API}/api/bots/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    Object.assign(bots.find(b => b.id == id), data);
    closeModal('settingsModal');
    renderTables();
    showToast('×”×”×’×“×¨×•×ª × ×©××¨×•');
  }

  async function addBot() {
    const phone = document.getElementById('newBotPhone').value.trim();
    if (!phone) return showToast('×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ');

    showLoader(true);
    const res = await fetch(`${API}/api/bots`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone_number: phone, status: 'inactive', access_mode: 'everyone' })
    });

    const newBot = await res.json();
    bots.push(newBot);
    document.getElementById('newBotPhone').value = '';
    renderTables();
    updateStats();
    showLoader(false);
    showToast('×”×‘×•×˜ × ×•×¡×£');
  }

  async function deleteBot(id) {
    if (!confirm('×œ××—×•×§ ××ª ×”×‘×•×˜?')) return;
    await fetch(`${API}/api/bots/${id}`, { method: 'DELETE' });
    bots = bots.filter(b => b.id !== id);
    renderTables();
    updateStats();
    showToast('×”×‘×•×˜ × ××—×§');
  }

  function openBlacklist() {
    currentListType = 'blacklist';
    currentBotId = null;
    document.getElementById('listModalTitle').innerHTML = '<i class="fa-solid fa-ban"></i> ××¡×¤×¨×™× ×—×¡×•××™×';
    renderList();
    document.getElementById('listModal').classList.add('open');
  }

  async function openWhitelist(botId, phone) {
    currentListType = 'whitelist';
    currentBotId = botId;
    document.getElementById('listModalTitle').innerHTML = `<i class="fa-solid fa-user-check"></i> ×¨×©×™××” ×œ×‘× ×” - ${phone}`;

    const res = await fetch(`${API}/api/whitelist/bot/${botId}`);
    whitelist = await res.json();

    renderList();
    document.getElementById('listModal').classList.add('open');
  }

  function renderList() {
    const container = document.getElementById('listContainer');
    const items = currentListType === 'blacklist' ? blacklist : whitelist;

    if (items.length === 0) {
      container.innerHTML = '<div class="list-empty"><i class="fa-solid fa-inbox"></i><br>××™×Ÿ ×¨×©×•××•×ª</div>';
      return;
    }

    container.innerHTML = items.map(item => `
      <div class="list-item">
        <span class="phone">${item.phone}</span>
        <button class="btn-icon delete" onclick="removeFromList('${item.phone}')">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    `).join('');
  }

  async function addToList() {
    const phone = document.getElementById('listPhoneInput').value.trim();
    if (!phone) return;

    if (currentListType === 'blacklist') {
      await fetch(`${API}/api/blocked`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone })
      });
      blacklist.push({ phone });
    } else {
      await fetch(`${API}/api/whitelist`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bot_id: currentBotId, phone })
      });
      whitelist.push({ phone });
    }

    document.getElementById('listPhoneInput').value = '';
    renderList();
    updateStats();
    showToast('× ×•×¡×£');
  }

  async function removeFromList(phone) {
    if (currentListType === 'blacklist') {
      await fetch(`${API}/api/blocked/${phone}`, { method: 'DELETE' });
      blacklist = blacklist.filter(b => b.phone !== phone);
    } else {
      await fetch(`${API}/api/whitelist/${currentBotId}/${phone}`, { method: 'DELETE' });
      whitelist = whitelist.filter(w => w.phone !== phone);
    }
    renderList();
    updateStats();
    showToast('× ××—×§');
  }

  function updateStats() {
    document.getElementById('stat-total').textContent = bots.length;
    document.getElementById('stat-active').textContent = bots.filter(b => b.status === 'active').length;
    document.getElementById('stat-blocked').textContent = blacklist.length;
  }

  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
  }

  function showLoader(show) {
    document.getElementById('loader').style.display = show ? 'flex' : 'none';
  }

  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }
</script>

</body>
</html>
